{% load static %} {% load i18n %} {% load horilla_tags %}

<div id="{{ view_id|safe }}-container" class="relative bg-white rounded-lg shadow-sm">
    <form hx-post="{{ form_url }}" id="{{ view_id|safe }}"
          hx-swap="outerHTML" hx-target="#{{ view_id|safe }}-container" enctype="multipart/form-data" hx-encoding="multipart/form-data">
        {% csrf_token %}
        <input type="hidden" name="dashboard" value="{{ dashboard.pk }}" />

        <!-- Render all hidden fields -->
        {% for field in form %}
            {% if field.is_hidden %}
                {{ field }}
            {% endif %}
        {% endfor %}

        <div style="display: none;">

            <div hx-get="{% url 'horilla_dashboard:get_grouping_field_choices' %}"
                 hx-target="#grouping_field_container"
                 hx-swap="innerHTML"
                 hx-include="[name='module']"
                 hx-trigger="change from:#id_module"
                hx-vals="js:{module: getModuleValue()}"
                 id="grouping-field-trigger"></div>

            <div hx-get="{% url 'horilla_dashboard:get_columns_field_choices' %}"
                 hx-target="#columns_container"
                 hx-swap="innerHTML"
                 hx-include="[name='module']"
                 hx-trigger="change from:#id_module"
                  hx-vals="js:{module: getModuleValue()}"
                 id="column-field-trigger"></div>
            <div hx-get="{% url 'horilla_dashboard:get_secondary_grouping_field_choices' %}"
                 hx-target="#secondary_grouping_container"
                 hx-swap="innerHTML"
                 hx-include="[name='module']"
                 hx-trigger="change from:#id_module"
                  hx-vals="js:{module: getModuleValue()}"
                 id="column-field-trigger"></div>
        </div>

        <div class="p-5">
            <div class="flex justify-between items-center mb-2">
                <h2 class="text-md font-semibold">{{ form_title }}</h2>
                <button type="button" onclick="closeModal()" class="text-gray-500 hover:text-red-500 text-xl cursor-pointer">
                    <img src="{% static 'assets/icons/close.svg' %}" alt="Close" />
                </button>
            </div>

            {% if form.non_field_errors %}
                <div class="bg-red-50 text-red-500 px-4 py-3 rounded-lg text-sm mb-4">
                    {% for error in form.non_field_errors %}
                        {{ error }}<br>
                    {% endfor %}
                </div>
            {% endif %}

            <div class="{% if modal_height %}h-[500px]{% endif %} overflow-hidden overflow-y-auto pe-2">
                <!-- Component Name field first -->
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-3">
                    {% for field in form %}
                        {% if not field.is_hidden and field.name not in condition_fields and field.name == 'name' %}
                            <div id="{{ field.name }}_container" class="col-span-2 flex flex-col h-[20px] mb-10">
                                <div class="flex justify-between items-center mb-1">
                                    <label for="{{ field.id_for_label }}" class="text-xs text-color-600">{{ field.label }}</label>
                                    {% if field.name in dynamic_create_fields and field.name in related_models_info %}
                                        <button type="button"
                                                class="text-primary-600 hover:text-primary-800 text-xs font-semibold px-2 py-1 bg-primary-300 rounded border border-primary-200 transition-colors"
                                                hx-get="{% url 'horilla_generics:dynamic_create' related_models_info|get_item_form:field.name|get_item_form:'app_label' related_models_info|get_item_form:field.name|get_item_form:'model_name' %}?target_field={{ field.name }}&fields={{ dynamic_create_field_mapping|get_item_form:field.name|get_item_form:'fields'|join:',' }}&full_width_fields={{ dynamic_create_field_mapping|get_item_form:field.name|get_item_form:'full_width_fields'|join:',' }}"
                                                hx-target="#dynamicCreateModalBox"
                                                hx-on:click="openDynamicModal();"
                                                hx-swap="innerHTML"
                                                hx-post="">
                                            + Add
                                        </button>
                                    {% endif %}
                                </div>
                                {{ field }}

                                {% if field.errors %}
                                    <div class="bg-red-50 text-red-500 px-3 py-2 rounded text-xs mt-1">
                                        {% for error in field.errors %}
                                            {{ error }}
                                        {% endfor %}
                                    </div>
                                {% endif %}
                            </div>
                        {% endif %}
                    {% endfor %}
                </div>

                <!-- Component Type and Chart Type fields -->
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-3">
                    {% for field in form %}
                        {% if not field.is_hidden and field.name not in condition_fields and field.name in 'component_type,chart_type' %}
                            <div id="{{ field.name }}_container" class="flex flex-col h-[20px] mb-10">
                                <div class="flex justify-between items-center mb-1">
                                    <label for="{{ field.id_for_label }}" class="text-xs text-color-600">{{ field.label }}</label>
                                </div>

                                <div class="preview-trigger-field">
                                    {% if field.name == 'component_type' %}
                                        <select name="{{ field.name }}"
                                                id="{{ field.id_for_label }}"
                                                class="{{ field.field.widget.attrs.class|default:'' }} form-control component_type"
                                                {% if form.instance.pk %}
                                                    hx-get="{% url 'horilla_dashboard:component_update' pk=form.instance.pk %}"
                                                {% else %}
                                                    hx-get="{% url 'horilla_dashboard:component_create' %}"
                                                {% endif %}
                                                hx-target="#dashboardcomponent-form-view-container"
                                                hx-swap="outerHTML"
                                                hx-include="#dashboardcomponent-form-view"
                                                hx-trigger="change"
                                                onchange="updatePreviewAfterFormSwap()">
                                            {% for choice in field.field.choices %}
                                                <option value="{{ choice.0 }}" {% if choice.0 == field.value %}selected{% endif %}>{{ choice.1 }}</option>
                                            {% endfor %}
                                        </select>
                                    {% elif field.name == 'chart_type' %}
                                        <select name="{{ field.name }}"
                                                id="{{ field.id_for_label }}"
                                                class="{{ field.field.widget.attrs.class|default:'' }} form-control"
                                                hx-get="{% url 'horilla_dashboard:preview_chart' %}"
                                                hx-target="#preview-container"
                                                hx-swap="innerHTML"
                                                hx-trigger="change,load"
                                                hx-include="[name='chart_type'],[name='component_type']">
                                            {% for choice in field.field.choices %}
                                                <option value="{{ choice.0 }}" {% if choice.0 == field.value %}selected{% endif %}>{{ choice.1 }}</option>
                                            {% endfor %}
                                        </select>
                                    {% endif %}
                                </div>

                                {% if field.errors %}
                                    <div class="bg-red-50 text-red-500 px-3 py-2 rounded text-xs mt-1">
                                        {% for error in field.errors %}
                                            {{ error }}
                                        {% endfor %}
                                    </div>
                                {% endif %}
                            </div>
                        {% endif %}
                    {% endfor %}
                </div>

                <!-- Preview Section -->
                <div class="mb-6">
                    <div class="flex justify-between items-center mb-3">
                        <h3 class="text-md font-semibold text-gray-700">{% trans "Preview" %}</h3>
                    </div>
                    <div class="bg-gray-50 rounded-lg p-4 h-[250px] flex items-center justify-center">
                        <div id="preview-wrapper" class="w-full h-full relative overflow-hidden">
                            <div id="preview-container" class="w-full h-full">
                                <div class="text-gray-500 text-sm flex items-center justify-center h-full">
                                    {% trans "Select component type to see preview" %}
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-3">
                    {% for field in form %}
                        {% if not field.is_hidden and field.name not in condition_fields and field.name not in 'component_type,chart_type,name' %}
                            <div id="{{ field.name }}_container" class="{% if field.name in full_width_fields %}col-span-2{% else %}{% if field.field.widget.input_type == 'checkbox' %}text-sm flex items-center gap-2 relative{% else %}flex flex-col h-[20px] mb-10{% endif %}{% endif %}">
                                {% if field.field.widget.input_type == 'checkbox' %}
                                    <label class="inline-flex items-center cursor-pointer">
                                        <span class="me-3 text-xs text-color-600">{{ field.label }}</span>
                                        {{ field }}
                                        <div class="relative w-10 h-5 bg-gray-200 rounded-full peer peer-checked:bg-primary-600 after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:rounded-full after:h-4 after:w-4 after:transition-all peer-checked:after:translate-x-5"></div>
                                    </label>
                                {% elif field.field.widget.input_type == 'file' %}
                                    <label class="inline-flex items-center cursor-pointer">
                                        <span class="me-3 text-xs text-color-600">{{ field.label }} </span>
                                    </label>
                                    <div class="w-full">
                                    <label
                                        for="{{ field.id_for_label }}"
                                        class="flex items-center gap-3 text-color-600 p-2 placeholder:text-xs font-normal w-full border border-dark-50 rounded-md mt-1 focus-visible:outline-0 placeholder:text-dark-100 text-sm transition duration-300 focus:border-primary-600 cursor-pointer"
                                    >
                                        <span
                                        class="inline-flex items-center px-3 py-1 bg-primary-600 text-white text-xs font-medium rounded-md hover:bg-primary-700 transition"
                                        >
                                        {% trans 'Choose File'%}
                                        </span>
                                        <span
                                        id="{{ field.id_for_label }}-name"
                                        class="text-sm text-gray-500"
                                        >
                                        {% if field.value %}{{ field.value|default:"No file chosen" }}
                                        {% else %}
                                        {% trans 'No file chosen'%}{% endif %}
                                        </span>
                                    </label>

                                    <div style="display: none">{{ field }}</div>
                                    </div>

                                    <script>
                                        function initFileInput{{ field.id_for_label|capfirst }}() {
                                            const input = document.getElementById('{{ field.id_for_label }}');
                                            const fileName = document.getElementById('{{ field.id_for_label }}-name');
                                            if (input && fileName) {
                                                input.addEventListener('change', function() {
                                                    if (this.files && this.files.length > 0) {
                                                        fileName.textContent = this.files[0].name;
                                                    } else {
                                                        fileName.textContent = 'No file chosen';
                                                    }
                                                });
                                            }
                                        }

                                        if (document.readyState === 'loading') {
                                            document.addEventListener('DOMContentLoaded', initFileInput{{ field.id_for_label|capfirst }});
                                        } else {
                                            initFileInput{{ field.id_for_label|capfirst }}();
                                        }
                                    </script>

                                {% else %}
                                    <div class="flex justify-between items-center mb-1">
                                        <label for="{{ field.id_for_label }}" class="text-xs text-color-600">{{ field.label }}</label>
                                            {% if field.name in dynamic_create_fields and field.name in related_models_info %}
                                                <button type="button"
                                                        class="text-primary-600 hover:text-primary-800 text-xs font-semibold px-2 py-1 bg-primary-300 rounded border border-primary-200 transition-colors"
                                                        hx-get="{% url 'horilla_generics:dynamic_create' related_models_info|get_item_form:field.name|get_item_form:'app_label' related_models_info|get_item_form:field.name|get_item_form:'model_name' %}?target_field={{ field.name }}&fields={{ dynamic_create_field_mapping|get_item_form:field.name|get_item_form:'fields'|join:',' }}&full_width_fields={{ dynamic_create_field_mapping|get_item_form:field.name|get_item_form:'full_width_fields'|join:',' }}"
                                                        hx-target="#dynamicCreateModalBox"
                                                        hx-on:click="openDynamicModal();"
                                                        hx-swap="innerHTML"
                                                        hx-post="">
                                                    + Add
                                                </button>
                                            {% endif %}
                                    </div>
                                    {{ field }}
                                {% endif %}

                                {% if field.errors %}
                                    <div class="bg-red-50 text-red-500 px-3 py-2 rounded text-xs mt-1">
                                        {% for error in field.errors %}
                                            {{ error }}
                                        {% endfor %}
                                    </div>
                                {% endif %}
                            </div>
                        {% endif %}
                    {% endfor %}
                </div>

                <!-- Condition Fields Section -->
                {% if condition_fields %}
                    <label class="text-xs font-semibold text-color-600 pb-2">{% if condition_fields_tiltle %} {{condition_fields_tiltle}}  {% else %} {% trans 'Conditions' %} {% endif %}</label>
                    <div id="condition-fields-container">
                        <div class="flex items-center gap-2 mb-2 condition-row" data-row-id="0" id="condition-row-0">
                            <div class="grid grid-cols-{{ condition_fields|length }} gap-2 flex-1 h-[20px] mb-7">
                                {% for field_name in condition_fields %}
                                    <div>
                                        <div id="id_{{ field_name }}_0_container">
                                            {% if submitted_condition_data.0 and field_name in submitted_condition_data.0 %}
                                                {% render_field_with_name form field_name "0" submitted_condition_data.0|get_item_form:field_name %}
                                            {% else %}
                                                {% render_field_with_name form field_name "0" %}
                                            {% endif %}
                                        </div>
                                    </div>
                                {% endfor %}
                            </div>
                        </div>

                        {% if submitted_condition_data %}
                            {% for row_id, row_data in submitted_condition_data.items %}
                                {% if row_id != "0" %}
                                    <div class="flex items-center gap-2 mb-2 condition-row" data-row-id="{{ row_id }}" id="condition-row-{{ row_id }}">
                                        <div class="grid grid-cols-{{ condition_fields|length }} gap-2 flex-1 h-[20px] mb-7">
                                            {% for field_name in condition_fields %}
                                                <div>
                                                    <div id="id_{{ field_name }}_{{ row_id }}_container">
                                                        {% render_field_with_name form field_name row_id row_data|get_item_form:field_name %}
                                                    </div>
                                                </div>
                                            {% endfor %}
                                        </div>
                                        <button type="button"
                                                class="remove-condition-row flex items-center justify-center w-6 h-6"
                                                hx-delete="/generics/remove-condition-row/{{ row_id }}/"
                                                hx-target="#condition-row-{{ row_id }}"
                                                hx-swap="outerHTML">
                                            <img src="{% static 'assets/icons/close-red.svg' %}" alt="Remove" class="w-3 h-3"/>
                                        </button>
                                    </div>
                                {% endif %}
                            {% endfor %}
                        {% elif existing_conditions %}
                            {% for condition in existing_conditions %}
                                {% if not forloop.first %}
                                    <div class="flex items-center gap-2 mb-2 condition-row" data-row-id="{{ forloop.counter }}" id="condition-row-{{ forloop.counter }}">
                                        <div class="grid grid-cols-{{ condition_fields|length }} gap-2 flex-1 h-[20px] mb-7">
                                            {% for field_name in condition_fields %}
                                                <div>
                                                    <div id="id_{{ field_name }}_{{ forloop.parentloop.counter }}_container">
                                                        {% if field_name == 'field' %}
                                                            <select name="{{ field_name }}_{{ forloop.parentloop.counter }}" class="js-example-basic-single headselect" id="id_{{ field_name }}_{{ forloop.parentloop.counter }}"
                                                                {% if field_name == 'field' %}
                                                                        hx-get="{% url 'horilla_generics:get_field_value_widget' %}"
                                                                        hx-target="#id_value_{{ forloop.parentloop.counter }}_container"
                                                                        hx-swap="innerHTML"
                                                                        hx-include="[name='{{ field_name }}_{{ forloop.parentloop.counter }}'],#id_value_{{ forloop.parentloop.counter }}"
                                                                        hx-vals='{"model_name": "{{ form.model_name }}", "row_id": "{{ forloop.parentloop.counter }}"}'
                                                                        hx-trigger="change,load"
                                                                    {% endif %}>
                                                                {% for choice in condition_field_choices|get_item_form:field_name %}
                                                                    <option value="{{ choice.0 }}" {% if choice.0 == condition|getter:field_name %}selected{% endif %}>{{ choice.1 }}</option>
                                                                {% endfor %}
                                                            </select>
                                                        {% else %}
                                                            {% render_field_with_name form field_name forloop.parentloop.counter condition|getter:field_name %}
                                                        {% endif %}
                                                    </div>
                                                </div>
                                            {% endfor %}
                                        </div>
                                        <button type="button"
                                                class="remove-condition-row flex items-center justify-center w-6 h-6"
                                                hx-delete="/generics/remove-condition-row/{{ forloop.counter }}/"
                                                hx-target="#condition-row-{{ forloop.counter }}"
                                                hx-swap="outerHTML">
                                            <img src="{% static 'assets/icons/close-red.svg' %}" alt="Remove" class="w-3 h-3"/>
                                        </button>
                                    </div>
                                {% endif %}
                            {% endfor %}
                        {% endif %}
                    </div>

                    {% if add_condition_url %}
                        <button type="button"
                                class="text-primary-600 hover:text-primary-800 text-xs font-semibold px-2 py-1 bg-primary-300 rounded border border-primary-200 transition-colors"
                                hx-get="{{ add_condition_url }}&row_id=next"
                                hx-target="#condition-fields-container"
                                hx-swap="beforeend"
                                hx-include="[name='module']">
                            + Add More
                        </button>
                    {% endif %}
                {% endif %}
            </div>
        </div>

        <div class="flex justify-end p-5 pt-0">
            <button type="submit" class="text-sm px-4 py-2 bg-primary-600 rounded-md hover:bg-primary-800 transition duration-300 text-[white]">
                {% trans "Save" %}
            </button>
        </div>
    </form>
</div>

<script>
    function getModuleValue() {
        const moduleSelect = document.getElementById('id_module');
        if (!moduleSelect) return '';

        const selectedOption = moduleSelect.options[moduleSelect.selectedIndex];
        return selectedOption ? selectedOption.text : '';
    }

    function updatePreviewAfterFormSwap() {
        window.pendingPreviewUpdate = true;
    }

    let previewUpdateTimeout = null;
    let isUpdatingPreview = false;

    function updatePreview() {
        const previewContainer = document.querySelector('#preview-container');
        if (!previewContainer) {
            return;
        }

        if (isUpdatingPreview) {
            return;
        }

        if (previewUpdateTimeout) {
            clearTimeout(previewUpdateTimeout);
        }

        previewUpdateTimeout = setTimeout(() => {
            isUpdatingPreview = true;

            const componentTypeField = document.querySelector('[name="component_type"]');
            const chartTypeField = document.querySelector('[name="chart_type"]');

            const params = new URLSearchParams();

            if (componentTypeField && componentTypeField.value) {
                params.append('component_type', componentTypeField.value);
            }
            if (chartTypeField && chartTypeField.value) {
                params.append('chart_type', chartTypeField.value);
            }

            const formElement = document.querySelector('#dashboardcomponent-form-view');
            if (formElement) {
                const formData = new FormData(formElement);
                for (let [key, value] of formData.entries()) {
                    if (!params.has(key) && key !== 'csrfmiddlewaretoken') {
                        params.append(key, value);
                    }
                }
            }

            const url = '{% url "horilla_dashboard:preview_chart" %}' + (params.toString() ? '?' + params.toString() : '');

            htmx.ajax('GET', url, {
                target: '#preview-container',
                swap: 'innerHTML'
            }).then(() => {
                setTimeout(() => {
                    isUpdatingPreview = false;
                }, 100);
            });

            previewUpdateTimeout = null;
        }, 150);
    }

    document.addEventListener('htmx:afterSwap', function(event) {
        if (event.detail.target.id && event.detail.target.id.includes('dashboardcomponent-form-view-container') && window.pendingPreviewUpdate) {
            window.pendingPreviewUpdate = false;
            setTimeout(updatePreview, 150);
        }
    });

    document.addEventListener('DOMContentLoaded', function() {
        setTimeout(updatePreview, 200);
    });

    $(document).ready(function () {
        const columns = $("#id_columns");
        if (!columns.is(":hidden")) {
            columns.select2();
        }

        const selectEl = document.querySelector('.component_type');
        if (selectEl && selectEl.value) {
            setTimeout(() => {
                updatePreview();
            }, 100);
        }
    });

    $(document).on('htmx:afterSwap', function(event) {
        const formContainer = document.querySelector('#dashboardcomponent-form-view-container');
        if (!formContainer) {
            return;
        }

        const columns = $("#id_columns");
        if (!columns.is(":hidden")) {
            columns.select2();
        }

        if (event.target && (
            event.target.id === 'dashboardcomponent-form-view-container' ||
            (event.target.closest && event.target.closest('#dashboardcomponent-form-view-container') && event.target.id !== 'preview-container')
        )) {
            const selectEl = document.querySelector('.component_type');
            if (selectEl && selectEl.value) {
                setTimeout(() => {
                    updatePreview();
                }, 100);
            }
        }
    });

    $(document).on('htmx:afterSettle', function(event) {
        const columns = $("#id_columns");
        if (!columns.is(":hidden")) {
            columns.select2();
        }
    });
</script>
