{% load static i18n horilla_tags %}

<div id="{{ view_id|safe }}-container" class="relative bg-white rounded-lg shadow-sm">
    <form hx-post="{{ form_url }}" id="{{ view_id|safe }}"
        hx-swap="outerHTML" hx-target="#{{ view_id|safe }}-container" enctype="multipart/form-data">
        {% csrf_token %}
        {% for field in form %}
            {% if field.is_hidden %}
                {{ field }}
            {% endif %}
        {% endfor %}
        <div class="p-5">
            <div class="flex justify-between items-center mb-2">
                <h2 class="text-md font-semibold">{{ form_title }}</h2>
                <button type="button" onclick="closeModal()" class="text-gray-500 hover:text-red-500 text-xl cursor-pointer">
                    <img src="{% static 'assets/icons/close.svg' %}" alt="Close" />
                </button>
            </div>

            {% if form.non_field_errors %}
                <div class="bg-red-50 text-red-500 px-4 py-3 rounded-lg text-sm mb-4">
                    {% for error in form.non_field_errors %}
                        {{ error }}<br>
                    {% endfor %}
                </div>
            {% endif %}

            <div class="{% if modal_height %}h-[500px]{% endif %} overflow-hidden overflow-y-auto pe-2">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-3">
                    <!-- is_role_based -->
                    <div class="text-sm flex items-center gap-2 relative">
                        <label class="inline-flex items-center cursor-pointer">
                            <span class="me-3 text-xs text-color-600">{{ form.is_role_based.label }}</span>
                            {{ form.is_role_based }}
                            <div class="relative w-10 h-5 bg-gray-200 rounded-full peer peer-checked:bg-primary-600 after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:rounded-full after:h-4 after:w-4 after:transition-all peer-checked:after:translate-x-5"></div>
                        </label>
                        {% if form.is_role_based.errors %}
                            <div class="bg-red-50 text-red-500 px-3 py-2 rounded text-xs mt-1">
                                {% for error in form.is_role_based.errors %}
                                    {{ error }}
                                {% endfor %}
                            </div>
                        {% endif %}
                    </div>

                    <!-- role_container -->
                    <div id="role_container">
                        {% if form.is_role_based.value %}
                            <div class="flex flex-col">
                                <label for="{{ form.role.id_for_label }}" class="text-xs text-color-600">{{ form.role.label }}</label>
                                {{ form.role }}
                            </div>
                        {% endif %}
                    </div>

                    <!-- is_period_same -->
                    <div class="text-sm flex items-center gap-2 relative">
                        <label class="inline-flex items-center cursor-pointer">
                            <span class="me-3 text-xs text-color-600">{{ form.is_period_same.label }}</span>
                            {{ form.is_period_same }}
                            <div class="relative w-10 h-5 bg-gray-200 rounded-full peer peer-checked:bg-primary-600 after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:rounded-full after:h-4 after:w-4 after:transition-all peer-checked:after:translate-x-5"></div>
                        </label>
                        {% if form.is_period_same.errors %}
                            <div class="bg-red-50 text-red-500 px-3 py-2 rounded text-xs mt-1">
                                {% for error in form.is_period_same.errors %}
                                    {{ error }}
                                {% endfor %}
                            </div>
                        {% endif %}
                    </div>

                    <!-- period_container -->
                    <div id="period_container">
                        {% if form.is_period_same.value %}
                            <div class="flex flex-col">
                                <label for="{{ form.period.id_for_label }}" class="text-xs text-color-600">{{ form.period.label }}</label>
                                {{ form.period }}
                            </div>
                        {% endif %}
                    </div>
                     <!-- is_forecast_type_same -->
                    <div class="text-sm flex items-center gap-2 relative">
                        <label class="inline-flex items-center cursor-pointer">
                            <span class="me-3 text-xs text-color-600">{{ form.is_forecast_type_same.label }}</span>
                            {{ form.is_forecast_type_same }}
                            <div class="relative w-10 h-5 bg-gray-200 rounded-full peer peer-checked:bg-primary-600 after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:rounded-full after:h-4 after:w-4 after:transition-all peer-checked:after:translate-x-5"></div>
                        </label>
                        {% if form.is_forecast_type_same.errors %}
                            <div class="bg-red-50 text-red-500 px-3 py-2 rounded text-xs mt-1">
                                {% for error in form.is_forecast_type_same.errors %}
                                    {{ error }}
                                {% endfor %}
                            </div>
                        {% endif %}
                    </div>

                    <!-- forecast_type_container -->
                    <div id="forecast_type_container">
                        {% if form.is_forecast_type_same.value %}
                            <div class="flex flex-col">
                                <label for="{{ form.forcasts_type.id_for_label }}" class="text-xs text-color-600">{{ form.forcasts_type.label }}</label>
                                {{ form.forcasts_type }}
                            </div>
                        {% endif %}
                    </div>

                    <!-- is_target_same -->
                    <div class="text-sm flex items-center gap-2 relative">
                        <label class="inline-flex items-center cursor-pointer">
                            <span class="me-3 text-xs text-color-600">{{ form.is_target_same.label }}</span>
                            {{ form.is_target_same }}
                            <div class="relative w-10 h-5 bg-gray-200 rounded-full peer peer-checked:bg-primary-600 after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:rounded-full after:h-4 after:w-4 after:transition-all peer-checked:after:translate-x-5"></div>
                        </label>

                        {% if form.is_target_same.errors %}
                            <div class="bg-red-50 text-red-500 px-3 py-2 rounded text-xs mt-1">
                                {% for error in form.is_target_same.errors %}
                                    {{ error }}
                                {% endfor %}
                            </div>
                        {% endif %}
                    </div>

                    <!-- target_container -->
                    <div id="target_container">
                        {% if form.is_target_same.value %}
                            <div class="flex flex-col">
                                <label for="{{ form.target_amount.id_for_label }}" class="text-xs text-color-600">{{ form.target_amount.label }}</label>
                                {{ form.target_amount }}
                            </div>
                            <div id="target_amount_help_text" class="text-xs text-gray-500 mt-1">
                                {{ form.target_amount.help_text }}
                            </div>
                        {% endif %}
                    </div>



                </div>

                <!-- Condition Fields Section -->
                {% if condition_fields %}
                    <label class="text-xs font-semibold text-color-600 pb-2">{% if condition_fields_tiltle %} {{condition_fields_tiltle}}  {% else %} {% trans 'Conditions' %} {% endif %}</label>
                    <div id="condition-fields-container">
                        {% include 'forecast_target/condition_fields.html' %}
                    </div>

                    {% if add_condition_url %}
                    <button type="button"
                            class="text-primary-600 hover:text-primary-800 text-xs font-semibold px-2 py-1 bg-primary-300 rounded border border-primary-200 transition-colors"
                            hx-get="{{ add_condition_url }}&row_id=next"
                            hx-include="[name='role'], [name='is_role_based'], [name='is_period_same'], [name='is_target_same'], [name='is_forecast_type_same']"
                            hx-target="#condition-fields-container"
                            hx-swap="beforeend">
                        + Add More
                    </button>
                    {% endif %}
                {% endif %}
            </div>
        </div>
        <div class="flex justify-end p-5 pt-0">
            <button type="submit" class="text-sm px-4 py-2 bg-primary-600 rounded-md hover:bg-primary-800 transition duration-300 text-[white]">
                {% trans "Save" %}
            </button>
        </div>
    </form>
</div>
<script>
    $(document).on("htmx:afterSettle", function () {
        initializeSelect2Pagination();
        $("select").on("select2:select", function (e) {
            $(this).closest("select")[0].dispatchEvent(new Event("change"));
        });
    });
</script>
