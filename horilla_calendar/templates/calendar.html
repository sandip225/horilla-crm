{% extends "index.html" %}
{% load static i18n horilla_tags%}
{% block content %}
<div class="flex modelcontent">
    {% include "components/sub_sidebar.html" %}

    <button id="markUnavailableBtn" style="display: none;" 
        hx-get="{% url 'horilla_calendar:mark_unavailability' %}" 
        hx-vals="{}"
        hx-target="#modalBox" 
        hx-swap="innerHTML">
        {% trans "Mark Unavailable" %}
    </button>
    <div id="mainContent" class="flex-[1_0] leftspace transition-all duration-300 ease-in-out pt-0">
        <button id="reloadMainContent" style="display: none;" hx-get="{% url 'horilla_calendar:calendar_view' %}{% if request.GET.display_only %}?display_only={{ request.GET.display_only }}{% endif %}" hx-target="#mainContent" hx-select="#mainContent"  hx-swap="outerHTML">
            Reload Content
        </button>
        <div id="messages-container" style="display: none;">
            {% for message in messages %}
                <div class="message" data-level="{{ message.tags }}" data-message="{{ message }}"></div>
            {% endfor %}
        </div>
        <div class="bg-white px-5 border-b border-b-dark-50 fixed w-fill-available z-10">
            <div class="flex flex-nowrap overflow-hidden overflow-x-auto items-center gap-2 justify-between">
                <div class="flex flex-col">
                    <h3 class="text-md font-semibold">{% trans 'Calendar' %}</h3>
                    <span class="text-sm" id="calendarTitle"></span>
                </div>
                <div class="flex items-center gap-10 h-[70px]">
                    <div class="flex items-center gap-10">
                    <div class="flex items-center gap-2">
                        <button id="prevBtn"
                            class="group text-xs p-2 w-8 h-8 flex justify-center items-center  bg-[#2996e33d] rounded-md hover:bg-[#3681b6] transition duration-300 text-[white] ">
                            <img
                                src="{% static 'assets/icons/prev.svg' %}"
                                alt=""
                                width="8"
                                class="group-hover:filter group-hover:brightness-0 group-hover:invert transition duration-300"
                            />
                        </button>
                        <button id="todayBtn"
                            class="text-xs px-3 py-2 bg-[#2995e3] rounded-md hover:bg-[#3681b6] transition duration-300 text-[white] h-8">
                            {% trans 'Today' %}
                        </button>
                        <button id="nextBtn"
                            class="group text-xs p-2 w-8 h-8 flex justify-center items-center  bg-[#2996e33d] rounded-md hover:bg-[#3681b6] transition duration-300 text-[white] ">
                            <img
                                src="{% static 'assets/icons/next.svg' %}"
                                alt=""
                                width="8"
                                class="group-hover:filter group-hover:brightness-0 group-hover:invert transition duration-300"
                            />
                        </button>
                    </div>
                    <div>
                        <div class="flex gap-2">
                            <button id="dayView"
                                class="tab-btn text-xs px-3 py-2 rounded-md transition duration-300 h-8 w-16 bg-[#2995e3] text-white">
                                {% trans 'Day' %}
                            </button>
                            <button id="weekView"
                                class="tab-btn text-xs px-3 py-2 rounded-md transition duration-300 h-8 w-16 bg-[#2996e33d] text-[#2995e3] hover:bg-[#2995e3] hover:text-white">
                                {% trans 'Week' %}
                            </button>
                            <button id="monthView"
                                class="tab-btn text-xs px-3 py-2 rounded-md transition duration-300 h-8 w-16 bg-[#2996e33d] text-[#2995e3] hover:bg-[#2995e3] hover:text-white">
                                {% trans 'Month' %}
                            </button>
                            <button id="yearView"
                                class="tab-btn text-xs px-3 py-2 rounded-md transition duration-300 h-8 w-16 bg-[#2996e33d] text-[#2995e3] hover:bg-[#2995e3] hover:text-white">
                                {% trans 'Year' %}
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <script>
            window.calendarInitialized = false;
            window.currentDisplayOnly = "{{ request.GET.display_only|default:'' }}";

            window.hasActivityCreatePerm = {% if perms.activity.add_activity %}true{% else %}false{% endif %};
            window.hasActivityChangeOwnPerm = {% if perms.activity.change_own_activity %}true{% else %}false{% endif %};
            window.hasActivityDeletePerm = {% if perms.activity.delete_activity %}true{% else %}false{% endif %};
            window.hasActivityViewOwnPerm = {% if perms.activity.view_own_activity %}true{% else %}false{% endif %};
            
            window.statusFieldPermission = "{{ status_field_permission }}";
            
            window.hasUnavailabilityCreatePerm = {% if perms.horilla_calendar.add_useravailability %}true{% else %}false{% endif %};
            window.hasUnavailabilityChangeOwnPerm = {% if perms.horilla_calendar.change_own_useravailability %}true{% else %}false{% endif %};
            window.hasUnavailabilityDeletePerm = {% if perms.horilla_calendar.delete_userunavalability%}true{%else%}false{%endif%};


            function getCalendarUrl(baseUrl) {
                if (window.currentDisplayOnly) {
                    return baseUrl + (baseUrl.includes('?') ? '&' : '?') + 'display_only=' + encodeURIComponent(window.currentDisplayOnly);
                }
                return baseUrl;
            }
        
            function updateEventStatus(eventId, newStatus) {
                fetch('{% url "horilla_calendar:mark_completed" %}', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': '{{ csrf_token }}'
                    },
                    body: JSON.stringify({
                        event_id: eventId,
                        status: newStatus
                    })
                })
                .then(response => {
                    if (!response.ok) {
                        throw new Error('Network response was not ok: ' + response.statusText);
                    }
                    return response.json();
                })
                .then(data => {
                    if (data.status === 'success') {
                        $('#reloadMainContent').click();
                        $("#calendarPopup").addClass("hidden");
                    } else {
                        alert('Error updating status: ' + (data.message || 'Unknown error'));
                    }
                })
                .catch(error => {
                    console.error('Fetch error:', error);
                    alert('Failed to update status: ' + error.message);
                });
            }
        
            // HTMX helper functions for calendar events
            function editEvent(eventId, editUrl) {
                htmx.ajax('GET', editUrl, {
                    target: '#modalBox',
                    swap: 'innerHTML'
                }).then(() => {
                    if (typeof openModal === 'function') {
                        openModal();
                    }
                    $("#calendarPopup").addClass("hidden");
                }).catch(error => {
                    console.error('Error editing event:', error);
                    alert('Failed to load edit form');
                });
            }
        
            function deleteEvent(eventId, deleteUrl) {
                if (!deleteUrl || deleteUrl === 'None' || deleteUrl === '#') {
                    alert('Delete action is not available for this event.');
                    return;
                }
        
                // Use HTMX for delete operations to match the expected flow
                htmx.ajax('POST', deleteUrl, {
                    headers: {
                        'X-CSRFToken': '{{ csrf_token }}',
                    },
                    values: {
                        'check_dependencies': 'true'
                    },
                    target: '#deleteModeBox',
                    swap: 'innerHTML'
                }).then(() => {
                    if (typeof openDeleteModeModal === 'function') {
                        openDeleteModeModal();
                    }
                    $("#calendarPopup").addClass("hidden");
                }).catch(error => {
                    console.error('Error deleting event:', error);
                    alert('Failed to delete event');
                });
            }
        
            function showEventInfo(eventId, detailUrl) {
                if (!detailUrl || detailUrl === 'None' || detailUrl === '#') {
                    alert('Detail view is not available for this event.');
                    return;
                }
        
                htmx.ajax('GET', detailUrl, {
                    target: '#mainContent',
                    swap: 'outerHTML',
                    select: '#mainContent',
                    pushUrl: true,
                    headers: {
                        'X-CSRFToken': '{{ csrf_token }}'
                    }
                }).then(() => {
                    $("#calendarPopup").addClass("hidden");
                }).catch(error => {
                    console.error('Error loading event details:', error);
                    alert('Failed to load event details');
                });
            }
        
            function createNewActivity(date) {
                htmx.ajax('GET', '{% url "horilla_activity:activity_create_form" %}?date=' + date + '&view=calendar', {
                    target: '#modalBox',
                    swap: 'innerHTML'
                }).then(() => {
                    if (typeof openModal === 'function') {
                        openModal();
                    }
                    $("#calendarPopup").addClass("hidden");
                }).catch(error => {
                    console.error('Error creating new activity:', error);
                    alert('Failed to load new activity form');
                });
            }
        
            function markDateUnavailable(clickedDate) {
                const hiddenBtn = document.getElementById('markUnavailableBtn');
                const data = {
                    start_date_time: clickedDate,
        
                };
                hiddenBtn.setAttribute('hx-vals', JSON.stringify(data));
                hiddenBtn.click();
                $("#calendarPopup").addClass("hidden");
            }
        
            document.addEventListener('htmx:afterRequest', function(event) {
                if (event.detail.elt.id === 'markUnavailableBtn' && event.detail.xhr.status === 200) {
                    if (typeof openModal === 'function') {
                        openModal();
                    }
                }
            });
        
            
        
            function initCalendar() {
                
                if (window.calendarInitialized) {
                    return;
                }
                window.calendarInitialized = true;
        
                const calendarEl = $("#calendar")[0];
                if (!calendarEl) {
                    return;
                  }
                const titleEl = $("#calendarTitle")[0];
                const popup = $("#calendarPopup")[0];
                const popupContent = $("#popupContent")[0];
        
                const today = new Date();
                const currentDate = today.toISOString().split('T')[0];
        
                const calendar = new FullCalendar.Calendar(calendarEl, {
                    height: "100%",
                    expandRows: true,
                    slotMinTime: "00:00:00",
                    slotMaxTime: "24:00:00",
                    scrollTime: "08:00:00",
                    slotDuration: "00:30:00",
                    headerToolbar: false,
                    initialView: window.currentView,
                    initialDate: currentDate,
                    navLinks: true,
                    editable: true,
                    eventDurationEditable: false,
                    selectable: true,
                    nowIndicator: true,
                    dayMaxEvents: true,
        
                    
                    views: {
                        timeGridDay: {
                            dayHeaderFormat: {
                                weekday: 'long',
                                day: 'numeric'
                            }
                        },
                        timeGridWeek: {
                            dayHeaderFormat: {
                                weekday: 'short',
                                day: 'numeric'
                            }
                        },
                        multiMonthYear: {
                            type: "multiMonth",
                            duration: { years: 1 },
                            buttonText: "Year",
                        },
                    },
                    
                    slotLabelFormat: {
                        hour: 'numeric',
                        minute: '2-digit',
                        omitZeroMinute: false,
                        meridiem: 'short'
                    },
                
                    events: function(fetchInfo, successCallback, failureCallback) {
                        const selectedTypes = Array.from(document.querySelectorAll('.calendar-checkbox:checked'))
                            .map(checkbox => checkbox.dataset.calendarType);
        
                        let url = '{% url "horilla_calendar:get_calendar_events" %}?calendar_types[]=' + selectedTypes.join('&calendar_types[]=');
                        if (window.currentDisplayOnly) {
                            url += '&display_only=' + encodeURIComponent(window.currentDisplayOnly);
                        }
        
                        fetch(url, {
                            headers: { 'X-CSRFToken': '{{ csrf_token }}',
                                    'X-Requested-With': 'XMLHttpRequest' },
                        })
                        .then(response => response.json())
                        .then(data => {
                            if (data.status === 'success') {
                                successCallback(data.events);
                            } else {
                                failureCallback(new Error(data.message));
                            }
                        })
                        .catch(error => failureCallback(error));
                    },
                    datesSet: function () {
                        titleEl.textContent = calendar.view.title;
                        window.currentView = calendar.view.type;
                        localStorage.setItem('calendarView', window.currentView);
                    },
                    eventTimeFormat: {
                        hour: "numeric",
                        minute: "2-digit",
                        meridiem: "short",
                    },
                    eventClick: function (info) {
                        info.jsEvent.preventDefault();
                        const event = info.event;
                        const rect = info.el.getBoundingClientRect();
                        const containerRect = calendarEl.getBoundingClientRect();
        
                        let content;
                        let icons;
        
                        if (event.extendedProps.calendarType === 'unavailability') {
                            // Content for unavailability events
                            content = `
                                <div class="flex flex-col gap-2">
                                    <h5>${event.title}</h5>
                                    <p><strong>{% trans 'Reason' %}:</strong> ${event.extendedProps.description || 'No reason provided'}</p>
                                    <div class="flex gap-1"><strong>{% trans 'Start Date' %}:</strong> ${event.start?.toLocaleString()}</div>
                                    <div class="flex gap-1"><strong>{% trans 'End Date' %}:</strong> ${event.end?.toLocaleString() || 'N/A'}</div>
                                </div>
                            `;
                            // Icons for unavailability (only Edit and Delete)
                            icons = `
                                <div class="flex gap-3 mt-2">
                                ${ window.hasUnavailabilityChangeOwnPerm ? `
                                    <button
                                        onclick="editEvent('${event.id}', '${event.url}')"
                                        class="text-blue-600 hover:text-blue-800"
                                    >
                                        <i class="fas fa-edit"></i> {% trans 'Edit' %}
                                    </button>
                                    ` : ''}
                                    ${window.hasUnavailabilityDeletePerm ? `
                                    <button
                                        onclick="deleteEvent('${event.id}', '${event.extendedProps.deleteUrl}')"
                                        class="text-red-600 hover:text-red-800"
                                    >
                                        <i class="fas fa-trash"></i> {% trans 'Delete' %}
                                    </button>
                                    ` : '' }
                                </div>
                            `;
                        } else {
                            // Content for other activity types
                            const subject = event.extendedProps.subject || "No subject";
                            const status = event.extendedProps.status;
                            const assignedToList = event.extendedProps.assignedTo || [];
                            const clientName = assignedToList.map(user => user.first_name).join(", ") || "No assigned user";
        
                            content = `
                                <div class="flex flex-col gap-2">
                                    <h5>${event.title}</h5>
                                    <span class="para"><strong>{% trans 'Subject' %}:</strong> ${subject}</span>
                                    <div class="flex gap-1"><strong>{% trans 'Start Date' %}:</strong> ${event.start?.toLocaleString()}</div>
                                    <div class="flex gap-1"><strong>{% trans 'End Date' %}:</strong> ${event.end?.toLocaleString()}</div>
                                    <p><strong>{% trans 'Assigned to' %}:</strong> ${clientName}</p>
                                    <p><strong>{% trans 'Status' %}:</strong> ${status}</p>
                                    ${status === "pending" && window.statusFieldPermission === "readwrite" ? `
                                     <div class="radio-group">
                                        <label>
                                            <input type="radio" name="status" value="complete" onclick="updateEventStatus('${event.id}', 'completed')"> {% trans 'Mark as Complete' %}
                                            <span class="custom-radio"></span>
                                        </label>
                                    </div>
                                    ` : ""}
                                </div>
                            `;
                            // Icons for other activities (Edit, Delete, Info)
                            icons = `
                                <div class="flex gap-3 mt-2">
                                ${window.hasActivityChangeOwnPerm ? `
                                    <button
                                        onclick="editEvent('${event.id}', '${event.url}')"
                                        class="text-blue-600 hover:text-blue-800"
                                    >
                                        <i class="fas fa-edit"></i> {% trans 'Edit' %}
                                    </button>
                                    ` : '' }
                                    ${window.hasActivityDeletePerm ? `
                                    <button
                                        onclick="deleteEvent('${event.id}', '${event.extendedProps.deleteUrl}')"
                                        class="text-red-600 hover:text-red-800"
                                    >
                                        <i class="fas fa-trash"></i> {% trans 'Delete' %}
                                    </button>
                                    ` : '' }
                                    ${window.hasActivityViewOwnPerm ? `
                                    <button
                                        onclick="showEventInfo('${event.id}', '${event.extendedProps.detailUrl}')"
                                        class="text-gray-600 hover:text-gray-800"
                                    >
                                        <i class="fas fa-info-circle"></i> {% trans 'Info' %}
                                    </button>
                                    ` :  '' }
                                </div>
                            `;
                        }
        
                        content += icons;
        
                        showPopup(
                            content,
                            rect.left - containerRect.left,
                            rect.top - containerRect.top
                        );
                    },
                    ...( (window.hasActivityCreatePerm || window.hasUnavailabilityCreatePerm) ? {
                        dateClick: function (info) {
                            const rect = info.dayEl.getBoundingClientRect();
                            const containerRect = calendarEl.getBoundingClientRect();
                            const clickedDate = info.dateStr;
            
                            let content = '<div class="flex flex-col gap-2">';
                            
                            if (window.hasActivityCreatePerm) {
                                content += `
                                    <button
                                        onclick="createNewActivity('${clickedDate}')"
                                        class="text-blue-600 hover:underline text-sm"
                                    >
                                        {% trans 'New Activity' %}
                                    </button>
                                `;
                            }
                            
                            if (window.hasUnavailabilityCreatePerm) {
                                content += `
                                    <button
                                        onclick="markDateUnavailable('${clickedDate}')"
                                        class="text-red-600 hover:underline text-sm"
                                    >
                                        {% trans 'Mark as Unavailable' %}
                                    </button>
                                `;
                            }
                            
                            content += '</div>';
            
                            showPopup(
                                content,
                                rect.left - containerRect.left,
                                rect.top - containerRect.top
                            );
                        },
                    } : {} ),
                    eventDidMount: function (info) {
                        const calendarType = info.event.extendedProps.calendarType;
                        const checkbox = document.querySelector(`.calendar-checkbox[data-calendar-type="${calendarType}"]`);
                        if (checkbox) {
                            const color = checkbox.style.borderColor || info.event.extendedProps.backgroundColor
                            info.el.style.backgroundColor = color;
                            info.el.style.borderColor = color;
                        }
                    },
                });
        
                calendar.render();
                syncMasterCheckbox();
        
                // Toolbar buttons
                $("#prevBtn").on("click", () => calendar.prev());
                $("#nextBtn").on("click", () => calendar.next());
                $("#todayBtn").on("click", () => calendar.today());
        
                // Tab buttons
                const tabButtons = $(".tab-btn");
        
                function setActiveTab(activeId) {
                    tabButtons.each(function() {
                        const $btn = $(this);
                        if ($btn.attr("id") === activeId) {
                            $btn.addClass("bg-[#2995e3] text-white")
                                .removeClass("bg-[#2996e33d] text-[#2995e3]");
                        } else {
                            $btn.addClass("bg-[#2996e33d] text-[#2995e3]")
                                .removeClass("bg-[#2995e3] text-white");
                        }
                    });
                }
        
                $("#dayView").on("click", () => {
                    calendar.changeView("timeGridDay");
                    window.currentView = "timeGridDay";
                    localStorage.setItem('calendarView', window.currentView);
                    setActiveTab("dayView");
                });
        
                $("#weekView").on("click", () => {
                    calendar.changeView("timeGridWeek");
                    window.currentView = "timeGridWeek";
                    localStorage.setItem('calendarView', window.currentView);
                    setActiveTab("weekView");
                });
        
                $("#monthView").on("click", () => {
                    calendar.changeView("dayGridMonth");
                    window.currentView = "dayGridMonth";
                    localStorage.setItem('calendarView', window.currentView);
                    setActiveTab("monthView");
                });
        
                $("#yearView").on("click", () => {
                    calendar.changeView("multiMonthYear");
                    window.currentView = "multiMonthYear";
                    localStorage.setItem('calendarView', window.currentView);
                    setActiveTab("yearView");
                });
        
                setActiveTab(
                    window.currentView === "timeGridDay" ? "dayView" :
                    window.currentView === "timeGridWeek" ? "weekView" :
                    window.currentView === "multiMonthYear" ? "yearView" : "monthView"
                );
        
        
                // Color picker functionality
                $('.calendar-color-picker').on('change', function () {
                    const calendarType = $(this).data('calendar-type');
                    const color = this.value;
                    const checkbox = $(`.calendar-checkbox[data-calendar-type="${calendarType}"]`)[0];
        
                    // Update checkbox styles
                    checkbox.style.borderColor = color;
                    if (checkbox.checked) {
                        checkbox.style.backgroundColor = color;
                    }
        
                    // Get currently selected calendar types
                    const selectedTypes = Array.from(document.querySelectorAll('.calendar-checkbox:checked'))
                        .map(checkbox => checkbox.dataset.calendarType);
        
                    // Save color preference to backend
                    $.ajax({
                        url: '{% url "horilla_calendar:save_calendar_preferences" %}',
                        method: 'POST',
                        headers: {
                            'X-CSRFToken': '{{ csrf_token }}',
                        },
                        contentType: 'application/json',
                        data: JSON.stringify({
                            calendar_type: calendarType,
                            color: color,
                            calendar_types: selectedTypes
                        }),
                        success: function (data) {
                            if (data.status === 'success') {
                                $('#reloadMainContent').click();
                                calendar.refetchEvents();
                                calendar.render();
                            } else {
                                console.error('Error saving color:', data.message);
                            }
                        },
                        error: function (error) {
                            console.error('Error:', error);
                        }
                    });
                });
        
                // Update checkbox background and refresh events when checked/unchecked
                $('.calendar-checkbox').on('change', function () {
                    if (this.checked) {
                        this.style.backgroundColor = this.style.borderColor;
                    } else {
                        this.style.backgroundColor = 'transparent';
                    }
                    syncMasterCheckbox();
        
                    const selectedTypes = Array.from(document.querySelectorAll('.calendar-checkbox:checked'))
                        .map(checkbox => checkbox.dataset.calendarType);
        
                    fetch('{% url "horilla_calendar:save_calendar_preferences" %}', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'X-CSRFToken': '{{ csrf_token }}',
                        },
                        body: JSON.stringify({ calendar_types: selectedTypes }),
                    })
                    .then(response => response.json())
                    .then(data => {
                        if (data.status === 'success') {
                            const url = '{% url "horilla_calendar:get_calendar_events" %}?' + selectedTypes.map(type => `calendar_types[]=${encodeURIComponent(type)}`).join('&');
                            fetch(url, {
                                headers: { 'X-CSRFToken': '{{ csrf_token }}',
                                         'X-Requested-With': 'XMLHttpRequest' },
                            })
                            .then(response => response.json())
                            .then(data => {
                                if (data.status === 'success') {
                                    calendar.getEventSources().forEach(source => source.remove());
                                    calendar.addEventSource(data.events);
                                    $('#reloadMainContent').click();
                                } else {
                                    console.error('Error fetching events:', data.message);
                                }
                            })
                            .catch(error => console.error('Fetch error:', error));
                        } else {
                            console.error('Error saving preferences:', data.message);
                        }
                    })
                    .catch(error => console.error('Fetch error:', error));
                });
        
                // Master checkbox logic for "My Calendars"
                $('#masterCheckbox').on('change', function() {
                    const isChecked = this.checked;
                    const allCheckboxes = $('.calendar-checkbox');
        
                    allCheckboxes.each(function() {
                        this.checked = isChecked;
                        if (isChecked) {
                            this.style.backgroundColor = this.style.borderColor;
                        } else {
                            this.style.backgroundColor = 'transparent';
                        }
                    });
        
                    const selectedTypes = isChecked ?
                        allCheckboxes.map(function() { return this.dataset.calendarType; }).get() :
                        [];
        
                    // Always send the request, even with empty array
                    $.ajax({
                        url: '{% url "horilla_calendar:save_calendar_preferences" %}',
                        method: 'POST',
                        headers: {
                            'X-CSRFToken': '{{ csrf_token }}',
                        },
                        contentType: 'application/json',
                        data: JSON.stringify({
                            calendar_types: selectedTypes
                        }),
                        success: function(data) {
                            if (data.status === 'success') {
                                calendar.getEventSources().forEach(source => source.remove());
        
                                if (selectedTypes.length > 0) {
                                    const url = '{% url "horilla_calendar:get_calendar_events" %}?' +
                                        selectedTypes.map(type => `calendar_types[]=${encodeURIComponent(type)}`).join('&');
        
                                    $.ajax({
                                        url: url,
                                        headers: { 'X-CSRFToken': '{{ csrf_token }}',
                                                  'X-Requested-With': 'XMLHttpRequest' },
        
                                        success: function(data) {
                                            if (data.status === 'success') {
                                                calendar.addEventSource(data.events);
                                                $('#reloadMainContent').click();
                                            } else {
                                                console.error('Error fetching events:', data.message);
                                            }
                                        },
                                        error: function(error) {
                                            console.error('Fetch error:', error);
                                        }
                                    });
                                }
                            } else {
                                console.error('Error saving preferences:', data.message);
                            }
                        },
                        error: function(error) {
                            console.error('Error:', error);
                        }
                    });
                });
        
                function syncMasterCheckbox() {
                    const masterCheckbox = $('#masterCheckbox')[0];
                    if (!masterCheckbox) {
                        return;
                      }
                    const calendarCheckboxes = $('.calendar-checkbox');
                    const checkedCount = calendarCheckboxes.filter(':checked').length;
                    const totalCount = calendarCheckboxes.length;
        
                    if (checkedCount === 0) {
                        masterCheckbox.checked = false;
                        masterCheckbox.indeterminate = false;
                    } else if (checkedCount === totalCount) {
                        masterCheckbox.checked = true;
                        masterCheckbox.indeterminate = false;
                    } else {
                        masterCheckbox.checked = false;
                        masterCheckbox.indeterminate = true;
                    }
                }
        
                // Sync checkbox state with "Display This Only" after HTMX settle
                $(document).on('htmx:afterSettle', function() {
                    const displayOnly = '{{ request.GET.display_only|default:"" }}';
                    if (displayOnly) {
                        $('.calendar-checkbox').each(function() {
                            const type = this.dataset.calendarType;
                            this.checked = (type === displayOnly);
                            if (this.checked) {
                                this.style.backgroundColor = this.style.borderColor;
                            } else {
                                this.style.backgroundColor = 'transparent';
                            }
                        });
                        calendar.refetchEvents();
                    }
                    syncMasterCheckbox();
                });
        
                // Popup functions
                function showPopup(content, x, y) {
                    popupContent.innerHTML = content;
                    popup.style.left = `${x}px`;
                    popup.style.top = `${y}px`;
                    $(popup).removeClass("hidden");
                }
        
                $("#closePopupBtn").on("click", () => {
                    $(popup).addClass("hidden");
                });
        
                $(document).on("click", function (e) {
                    if (!$(popup).has(e.target).length && !$(e.target).closest(".fc-event").length) {
                        $(popup).addClass("hidden");
                    }
                });
        
                window.showPopup = showPopup;
            }
        
            
            $(document).on("htmx:beforeRequest", function(event) {
                if (event.detail.target.id === "mainContent") {
                    window.calendarInitialized = false;
                }
            });
        
            $(document).on("htmx:afterSettle", function(event) {
                const urlParams = new URLSearchParams(window.location.search);
                window.currentDisplayOnly = urlParams.get('display_only') || '';
        
                if (!window.calendarInitialized) {
                    initCalendar();
                }
                let activeLinkId = "#" + localStorage.getItem("activeSidebarLinkId");
                if (activeLinkId) {
                    $(activeLinkId).addClass("bg-primary-600 text-white").find("img").css("filter", "brightness(0) invert(1)");
                }
            });
        </script> 
    </div>

    <div class="p-5 pt-24">
        <div class="block lg:grid grid-cols-12 grid-rows-1 gap-4">
            <div class="col-span-6 lg:col-span-10">
                <div class="h-full [box-shadow:0px_0px_20px_0px_rgb(0_0_0_/_5%)] bg-white rounded-lg z-0 p-4">
                    <div id="calendar-container">
                        <div id="calendar"></div>
                        <div id="calendarPopup"
                            class="absolute bg-white border border-gray-300 shadow-lg rounded-md p-4 text-sm text-gray-800 hidden z-50">
                            <button
                                id="closePopupBtn"
                                class="absolute top-1 right-2 text-gray-500 hover:text-black">
                                âœ•
                            </button>
                            <div id="popupContent"></div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-span-6 lg:col-span-2">
                <div class="h-full shadow-[0px_0px_20px_0px_rgba(0,0,0,0.05)] bg-white rounded-lg z-0 p-4">
                    <div class="flex items-center gap-1">
                        <div class="w-3">
                            <input type="checkbox" 
                                class="w-5 h-5 border-2 rounded-sm focus:ring-0 master-checkbox" 
                                id="masterCheckbox">
                        </div>   
                        <span class="flex-2 p-3 text-sm">{% trans 'My Calendars' %}</span>
                    </div>
                    <div>
                        {% for calendar in calendars %}
                            <div class="flex items-center justify-between gap-2 mb-3 relative">
                                <div class="flex gap-2 text-sm items-center flex-1">
                                    <div class="w-5">
                                        <input 
                                            type="checkbox" 
                                            class="w-5 h-5 border-2 rounded-sm focus:ring-0 calendar-checkbox" 
                                            data-calendar-type="{{ calendar.id }}"
                                            {% if calendar.selected %}
                                                style="border-color: {{ user_preferences|lookup:calendar.id|default:calendar.default_color }}; background-color: {{ user_preferences|lookup:calendar.id|default:calendar.default_color }};"
                                            {% else %}
                                                style="border-color: {{ user_preferences|lookup:calendar.id|default:calendar.default_color }}; background-color: transparent;"
                                            {% endif %}
                                            {% if calendar.selected %}checked{% endif %}
                                        >
                                    </div>                        
                                    <span class="flex-1">{% trans calendar.name %}</span>
                                </div>
                                <div class="relative dropdown-wrapper">
                                    <button class="text-gray-600 hover:text-gray-800 transition-colors flex items-center justify-center w-6 h-6">
                                        <img src="{% static 'assets/icons/down.svg' %}" alt="Dropdown" width="13" />
                                    </button>
                                    <div class="dropdown-content w-48 absolute bg-white rounded-lg [box-shadow:0px_0px_20px_0px_rgb(0_0_0_/_8%)] py-2 right-5 top-full z-60">
                                        <ul class="text-sm">
                                            <li>
                                                <button 
                                                    class="px-4 py-1.5 hover:text-primary-600 transition duration-300 text-sm w-full text-left"
                                                    hx-get="{% url 'horilla_calendar:calendar_view' %}?display_only={{ calendar.id }}"
                                                    hx-target="#mainContent"
                                                    hx-select="#mainContent"
                                                    hx-swap="outerHTML"
                                                >
                                                    {% trans 'Display This Only' %}
                                                </button>
                                            </li>
                                            <li class="px-4 py-1.5 flex items-center gap-2">
                                                <span class="hover:text-primary-600 transition duration-300 text-sm">{% trans 'Color' %}</span>
                                                <input 
                                                    type="color" 
                                                    class="w-20 h-6 border-none outline-none cursor-pointer calendar-color-picker" 
                                                    value="{{ user_preferences|lookup:calendar.id|default:calendar.default_color }}"
                                                    data-calendar-type="{{ calendar.id }}"
                                                >
                                            </li>
                                        </ul>
                                    </div>
                                </div>
                            </div>
                        {% endfor %}
                        
                    </div>
                </div>
            </div>
        </div>
    </div>
    
</div>     
<script>
    $(document).ready(function () {
        if (!window.calendarInitialized) {
            initCalendar();
        }
    });
</script>
  
{% endblock content %}
